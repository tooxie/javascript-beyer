<!DOCTYPE html>
<html ng-app>
    <head>
        <title>Beyer Music Player // Mozilla Dev Derby</title>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.0.1/angular.min.js"></script>
        <script type="text/javascript" src="https://raw.github.com/aadsm/JavaScript-ID3-Reader/master/src/id3.js"></script>
        <link rel="stylesheet" type="text/css" href="http://cdn.jsdelivr.net/foundation/3.2.4/stylesheets/foundation.min.css">
        <style type="text/css">
            #playlist .empty, #player {
                text-align: center;
            }

            #playlist.over {
                background-color: rgb(43, 166, 203);
            }

            #timer {
                float: left;
                margin-top: -18px;
                width: 100%;
            }

            .meter {
                width: 0;
            }

            .active {
                font-weight: bold;
            }
        </style>
        <script type="text/javascript">
            Beyer = {};
            Beyer.Playlist = {
                index: 0,
                isPlaying: false,
                audio: null,
                trackList: [],
                errors: [],
                addTrack: function(track) {
                    var canPlay = (new Audio()).canPlayType(track.type);
                    if (canPlay == "probably" || canPlay == "maybe") {
                        console.log('Adding ' + track.name);
                        this.trackList = this.trackList.concat(track);
                    } else {
                        this.addError("Format '" + track.type + "' is not supported by your browser.");
                    }
                },
                load: function(index) {
                    var track = this.trackList[this.index],
                        url = window.URL || window.webkitURL,
                        src = url.createObjectURL(track);

                    this.audio = new Audio();
                    this.audio.src = src;
                    this.audio.load();

                    this.audio.addEventListener('loadedmetadata', function(){
                        var mins = Math.floor(this.duration / 60),
                            secs = (Math.floor(this.duration) % 60).toFixed();

                        secs = (secs.length < 2) ? "0" + secs : secs;

                        this.durationAsString = mins + ':' + secs;
                    }, false);

                    this.audio.addEventListener('timeupdate', function() {
                        var mins = Math.floor(this.currentTime / 60),
                            secs = (Math.floor(this.currentTime) % 60).toFixed() + '',
                            elapsed = ((this.currentTime / this.duration) * 100) + "%",
                            progressbar = document.getElementById('progressbar'),
                            timer = document.getElementById('timer');

                        secs = (secs.length < 2) ? "0" + secs : secs;

                        timer.innerHTML = mins + ':' + secs + ' / ' + this.durationAsString;
                        progressbar.style.width = elapsed + '%';
                    }, false);

                    this.audio.addEventListener('ended', function(){
                        if (Beyer.Playlist.index + 1 < Beyer.Playlist.trackList.length) {
                            Beyer.Playlist.next();
                        } else {
                            Beyer.Playlist.pause();
                        }
                    }, false);
                },
                play: function () {
                    console.log('Playing ' + this.trackList[this.index].name);
                    this.isPlaying = true;
                    this.audio.play();
                },
                pause: function() {
                    this.isPlaying = false;
                    this.audio.pause();
                },
                togglePlay: function() {
                    if (!this.trackList.length) {
                        return false;
                    }
                    if (this.isPlaying) {
                        this.pause();
                    } else {
                        this.play();
                    }
                },
                prev: function() {
                    this.index = this.index == 0 ? this.trackList.length - 1 : this.index - 1;
                    console.log(this.index);
                    this.reload();
                },
                next: function() {
                    this.index = (this.index + 1) % this.trackList.length;
                    console.log(this.index);
                    this.reload();
                },
                reload: function() {
                    this.pause();
                    this.audio.src = '';
                    this.audio = undefined;
                    this.load();
                    this.play();
                },
                seek: function(percentage) {
                    var newCurrentTime = ((percentage * this.audio.duration) / 100);

                    console.log('Seeking to ' + percentage + '%');

                    this.jumpTo(newCurrentTime);
                },
                jumpTo: function(time) {
                    this.audio.currentTime = time;
                },
                addError: function(error) {
                    var exists = false,
                        x = this.errors.length;

                    while (x--) {
                        if (this.errors[x] == error) {
                            exists = true;
                        }
                    }
                    if (!exists) {
                        this.errors = this.errors.concat(error);
                        console.log('[ERROR] ' + error);
                    }
                },
                removeError: function (error) {
                    var x = this.errors.length;
                    while (x--) {
                        if (this.errors[x] == error) {
                            this.errors.splice(x, 1);
                        }
                    }
                }
            };

            // AngularJS stuff
            Beyer.controller = function ($scope) {
                $scope.playlist = Beyer.Playlist;

                var dropzone = document.getElementById('dropzone');

                dropzone.addEventListener('drop', function (e) {
                    document.getElementById('playlist').classList.remove('over');
                    e.stopPropagation();
                    e.preventDefault();

                    var tracks = e.dataTransfer.files;
                    for (var i = 0, track; track = tracks[i]; i++) {
                        Beyer.Playlist.addTrack(track);
                    }

                    if (!Beyer.Playlist.audio && Beyer.Playlist.trackList.length) {
                        Beyer.Playlist.load();
                    }

                    $scope.$apply(function () {});
                }, false);

                dropzone.addEventListener('dragend', function (e) {
                    document.getElementById('playlist').classList.remove('over');
                }, false);

                dropzone.addEventListener('dragenter', function (e) {
                    document.getElementById('playlist').classList.add('over');
                }, false);

                dropzone.addEventListener('dragover', function (e) {
                    e.stopPropagation();
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'copy';
                }, false)

                document.getElementById('seeker').addEventListener('click', function(e) {
                    var offset = e.offsetX || e.offsetLeft,
                        width = e.target.offsetWidth
                        percentage = ((offset / width) * 100);

                    Beyer.Playlist.seek(percentage);
                }, false);
            };
        </script>
    </head>

    <body id="dropzone" ng-controller="Beyer.controller">
        <div class="row">
            <h1>
                Beyer Music Player
            </h1>

            <hr>

            <div id="errors" ng-show="playlist.errors.length">
                <div class="alert-box alert" ng-repeat="error in playlist.errors">
                    {{ error }}
                    <a href="" class="close" ng-click="playlist.removeError(error)">&times;</a>
                </div>
            </div>

            <div id="player" class="panel radius">
                <h4 class="subheader">
                    {{ playlist.trackList[playlist.index].name }}
                </h3>
                <div id="seeker" class="progress" ng-show="playlist.audio">
                    <span id="progressbar" class="meter"></span>
                    <span id="timer">0:00</span>
                </div>
                <ul class="button-group radius">
                    <li>
                        <a href="#" class="button radius" ng-show="!playlist.isPlaying" ng-click="playlist.togglePlay()">Play</a>
                        <a href="#" class="button radius" ng-show="playlist.isPlaying" ng-click="playlist.togglePlay()">Pause</a>
                    </li>
                    <li>
                        <a href="#" class="button radius" ng-click="playlist.prev()">Prev</a>
                    </li>
                    <li>
                        <a href="#" class="button radius" ng-click="playlist.next()">Next</a>
                    </li>
                </ul>
            </div>

            <h2>
                Playlist
            </h2>
            <div id="playlist" class="panel radius">
                <div class="empty" ng-hide="playlist.trackList.length">
                    Drop music here
                </div>
                <ol>
                    <li ng-repeat="track in playlist.trackList" ng-class="{track: 1, active: $index==playlist.index, even: $index%2==0, odd: !($index%2==0)}">
                        {{ track.name }}
                    </li>
                </ol>
            </div>
        </div>
    </body>
</html>
