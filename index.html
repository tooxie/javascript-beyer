<!DOCTYPE html>
<html ng-app>
    <head>
        <title>Beyer Music Player // Mozilla Dev Derby</title>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.0.1/angular.min.js"></script>
        <script type="text/javascript" src="https://raw.github.com/aadsm/JavaScript-ID3-Reader/master/src/id3.js"></script>
        <link rel="stylesheet" type="text/css" href="http://cdn.jsdelivr.net/foundation/3.2.4/stylesheets/foundation.min.css">
        <style type="text/css">
            #playlist .empty {
                text-align: center;
            }

            #playlist.over {
                background-color: rgba(43, 166, 203, 0.7);
            }
        </style>
        <script type="text/javascript">
            Beyer = {};
            Beyer.Playlist = {
                audio: null,
                trackList: [],
                addTrack: function(track) {
                    if (this.isSupported(track.type)) {
                        console.log('Adding ' + track.name);
                        this.trackList = this.trackList.concat(track);
                    }
                },
                isSupported: function(type) {
                    if (type == "audio/mp3" || type == "audio/ogg") {
                        return true;
                    }

                    return false;
                },
                play: function(index) {
                    var track = this.trackList[index || 0],
                        url = window.URL || window.webkitURL,
                        src = url.createObjectURL(track);

                    this.audio = new Audio();
                    this.audio.src = src;
                    this.audio.load();
                    this.audio.play();
                    console.log('Playing ' + track.name);
                },
                pause: function() {
                    this.audio.pause();
                }
            }

            // AngularJS
            // Beyer.app = angular.module('beyer', []);
            Beyer.controller = function ($scope) {
                $scope.playlist = Beyer.Playlist.trackList;

                var dropzone = document.getElementById('dropzone');

                dropzone.addEventListener('drop', function (e) {
                    document.getElementById('playlist').classList.remove('over');
                    e.stopPropagation();
                    e.preventDefault();

                    var tracks = e.dataTransfer.files;
                    for (var i = 0, track; track = tracks[i]; i++) {
                        Beyer.Playlist.addTrack(track);
                    }

                    $scope.$apply(function() {
                        $scope.playlist = Beyer.Playlist.trackList;
                    });

                    Beyer.Playlist.play();
                }, false);

                dropzone.addEventListener('dragend', function (e) {
                    document.getElementById('playlist').classList.remove('over');
                }, false);

                dropzone.addEventListener('dragenter', function (e) {
                    document.getElementById('playlist').classList.add('over');
                }, false);

                dropzone.addEventListener('dragover', function (e) {
                    e.stopPropagation();
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'copy';
                }, false)
            };

            document.addEventListener('DOMContentLoaded', function() {
            }, false);
        </script>
    </head>

    <body id="dropzone" ng-controller="Beyer.controller">
        <div class="row">
            <h1>
                Beyer Music Player
            </h1>

            <hr>

            <h2>
                Playlist
            </h2>
            <div id="playlist" class="panel radius">
                <div class="empty" ng-hide="playlist.length">
                    Drop music here
                </div>
                <ol>
                    <li ng-repeat="track in playlist">
                        {{ track.name }} ({{ track.size / 1024 }}Kb)
                    </li>
                </ol>
            </div>
        </div>
    </body>
</html>
