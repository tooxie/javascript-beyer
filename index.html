<!DOCTYPE html>
<html ng-app>
    <head>
        <title>Beyer Music Player // Mozilla Dev Derby</title>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.0.1/angular.min.js"></script>
        <script type="text/javascript" src="https://raw.github.com/aadsm/JavaScript-ID3-Reader/master/src/id3.js"></script>
        <link rel="stylesheet" type="text/css" href="http://cdn.jsdelivr.net/foundation/3.2.4/stylesheets/foundation.min.css">
        <style type="text/css">
            #playlist .empty, #player {
                text-align: center;
            }

            #playlist.over {
                background-color: rgb(43, 166, 203);
            }

            .songname {
                float: left;
                margin-top: -18px;
                width: 100%;
            }

            .active {
                font-weight: bold;
            }
        </style>
        <script type="text/javascript">
            Beyer = {};
            Beyer.Playlist = {
                index: 0,
                isPlaying: false,
                audio: null,
                trackList: [],
                addTrack: function(track) {
                    if (this.isSupported(track.type)) {
                        console.log('Adding ' + track.name);
                        this.trackList = this.trackList.concat(track);
                    }
                },
                isSupported: function(type) {
                    if (type == "audio/mp3" || type == "audio/ogg") {
                        return true;
                    }

                    return false;
                },
                load: function(index) {
                    var track = this.trackList[index || 0],
                        url = window.URL || window.webkitURL,
                        src = url.createObjectURL(track);

                    this.index = index || 0;

                    this.audio = new Audio();
                    this.audio.src = src;
                    this.audio.load();
                },
                play: function () {
                    console.log('Playing ' + this.trackList[this.index].name);
                    this.isPlaying = true;
                    this.audio.play();
                },
                pause: function() {
                    this.isPlaying = false;
                    this.audio.pause();
                },
                togglePlay: function() {
                    if (this.isPlaying) {
                        this.pause();
                    } else {
                        this.play();
                    }
                }
            };

            // AngularJS stuff
            Beyer.controller = function ($scope) {
                $scope.playlist = Beyer.Playlist;

                var dropzone = document.getElementById('dropzone');

                dropzone.addEventListener('drop', function (e) {
                    document.getElementById('playlist').classList.remove('over');
                    e.stopPropagation();
                    e.preventDefault();

                    var tracks = e.dataTransfer.files;
                    for (var i = 0, track; track = tracks[i]; i++) {
                        Beyer.Playlist.addTrack(track);
                    }

                    if (!Beyer.Playlist.audio) {
                        Beyer.Playlist.load();
                    }

                    $scope.$apply(function () {});
                }, false);

                dropzone.addEventListener('dragend', function (e) {
                    document.getElementById('playlist').classList.remove('over');
                }, false);

                dropzone.addEventListener('dragenter', function (e) {
                    document.getElementById('playlist').classList.add('over');
                }, false);

                dropzone.addEventListener('dragover', function (e) {
                    e.stopPropagation();
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'copy';
                }, false)
            };
        </script>
    </head>

    <body id="dropzone" ng-controller="Beyer.controller">
        <div class="row">
            <h1>
                Beyer Music Player
            </h1>

            <hr>

            <div id="player" class="panel radius">
                <div class="progress" ng-show="playlist.audio">
                    <span class="meter"></span>
                    <span class="songname">{{ playlist.trackList[playlist.index].name }}</span>
                </div>
                <ul class="button-group radius">
                    <li>
                        <a href="#" class="button radius" ng-show="!playlist.isPlaying" ng-click="playlist.togglePlay()">Play</a>
                        <a href="#" class="button radius" ng-show="playlist.isPlaying" ng-click="playlist.togglePlay()">Pause</a>
                    </li>
                    <li>
                        <a href="#" class="button radius">Prev</a>
                    </li>
                    <li>
                        <a href="#" class="button radius">Next</a>
                    </li>
                </ul>
            </div>

            <h2>
                Playlist
            </h2>
            <div id="playlist" class="panel radius">
                <div class="empty" ng-hide="playlist.trackList.length">
                    Drop music here
                </div>
                <ol>
                    <li ng-repeat="track in playlist.trackList" ng-class="{track: 1, active: $index==playlist.index, even: $index%2==0, odd: !($index%2==0)}">
                        {{ track.name }} ({{ track.size / 1024 }}Kb)
                    </li>
                </ol>
            </div>
        </div>
    </body>
</html>
